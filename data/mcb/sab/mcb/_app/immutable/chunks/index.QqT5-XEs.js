var Y=Object.defineProperty;var z=(e,i,a)=>i in e?Y(e,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[i]=a;var x=(e,i,a)=>z(e,typeof i!="symbol"?i+"":i,a);import{W as f,X as p,Y as H,h as D,Z as V,_ as E,$ as U,a0 as _,a1 as W,a2 as B,r as m,a3 as G}from"./theme.CEnq8wkH.js";import{a as T}from"./history.D4VpaZ3J.js";import{b as k,g as M}from"./entry.BaUVQd1j.js";import{p as S}from"./scheduler.B2eiZa_g.js";import{a as K,b as q,c as J}from"./analytics.D282VuiN.js";class X{constructor(i){x(this,"capacity");x(this,"cache");this.capacity=i,this.cache=new Map}get(i){if(this.cache.has(i)){const a=this.cache.get(i);return this.cache.delete(i),this.cache.set(i,a),a}return null}put(i,a){if(this.cache.has(i))this.cache.delete(i);else if(this.cache.size===this.capacity){const n=this.cache.keys().next().value;this.cache.delete(n)}this.cache.set(i,a)}clear(){this.cache.clear()}size(){return this.cache.size}print(){console.log("Cache Contents:");for(let[i,a]of this.cache)console.log(`${i}:`,a)}}const O=new X(10);let t;f.subscribe(async e=>{t=e,await ee()});let r;p.subscribe(e=>{r&&r.mode!==e.mode&&e.mode===E&&(e.range=R()),r=e});function Z(e,i,a){return`${e}-${i}-${a}`}function fe(e){const i=Z(e.collection,e.book,e.chapter);let a=O.get(i);a?a.audio&&(a.audio.currentTime=0,a.progress=0,a.timeIndex=0):(a={...e,...G},O.put(i,a)),f.set(a)}function Q(e){const i=new Audio;var a=document.createElement("source");if(a.src=e,i.appendChild(a),/\.webm$/i.test(e)){var n=document.createElement("source");n.src=e.replace(/\.webm$/i,".caf"),n.type="audio/x-caf";var s=document.createElement("source");s.src=e.replace(/\.webm$/i,".mp3"),s.type="audio/mpeg",i.appendChild(n),i.appendChild(s)}return i}async function ee(){if(t.loaded)return;t.duration=0,t.progress=0,t.playing&&u();const e=await ne(t);if(!e)return;t.timing=e.timing;const i=Q(e.source);i.onloadedmetadata=()=>{t.duration=i.duration,t.timeIndex=0,t.loaded=!0,t.audio=i,f.set(t),h()}}function ge(){t.loaded&&(t.playing===!0?u():y(),f.set(t))}function N(){t.loaded&&t.playing===!0&&u()}async function j(e){u(),await m.skip(e)}function me(e){if(isNaN(e))return"0:00";const i=Math.floor(e/60);return e=Math.floor(e%60),e<10&&(e="0"+e),`${i}:${e}`}async function pe(e){if(!t.loaded)return;const i=t.playing;if(u(),e>=0)if(t.timing[t.timeIndex]!=t.timing.at(-1)){t.timeIndex++;const a=t.timing[t.timeIndex].starttime;t.audio.currentTime=a,h()}else await j(1);else t.timeIndex>0&&t.timeIndex--,t.audio.currentTime=t.timing[t.timeIndex].starttime,h();i&&y()}function F(e){const i=t.playing;u(),t.audio?t.audio.currentTime=e:console.log("audio seek: current audio player audio missing "),t.progress=e,p.set({...r,range:R()}),f.set(t),i===!0&&y()}let g;async function te(){if(g){g--,g===0&&(r.mode===_?(await j(1),p.set({...r,continue:!0})):r.mode===B?F(0):r.mode===E&&(F(r.range.start),y()),g=void 0);return}if(t.audio.ended){r.mode===U?(u(),f.set(t)):g=5;return}if(r.mode===_&&r.continue&&(p.set({...r,continue:!1}),y()),r.mode===E){if(r.range===W.range){const e=R();if(e.start===void 0||e.end===void 0)return;p.set({...r,range:{start:e.start,end:e.end}})}t.progress+.05>r.range.end&&(u(),g=5)}}function R(){let e,i;for(let a=0;a<t.timing.length;a++){const n=t.timing[a];if(t.progress>=n.starttime&&t.progress<n.endtime){const s=parseInt(n.tag,10);for(let o=a+1;o>=0;o--){if(parseInt(t.timing[o].tag,10)!==s){i=t.timing[o+1].tag;break}if(o===0){i=t.timing.tag;break}}for(let o=a+1;o<t.timing.length;o++){if(parseInt(t.timing[o].tag,10)!==s){e=t.timing[o-1].tag;break}if(o===t.timing.length-1){e=t.timing.tag;break}}break}}return oe(i,e)}async function h(){t.loaded&&(t.progress=t.audio.currentTime,!t.timing&&t.progress&&f.set(t),t.timing&&t.progress&&ie(),await te())}function L(){t.audio.ended||t.playing===!1?(clearInterval(t.timer),t.timer=null):t.timer=setInterval(()=>h(),100)}function he(){return t.progress>0}function u(){var e;t.loaded&&(t.playing&&((e=t.audio)==null||e.pause(),K(t),t.playing=!1),L())}function y(){var e;t.loaded&&(t.playing||((e=t.audio)==null||e.play(),t.playStart=Date.now(),q(t),t.playing=!0),L())}function ie(){const e=[];for(let i=0;i<t.timing.length;i++){const a=t.timing[i];t.progress>=a.starttime&&t.progress<a.endtime&&(t.timeIndex=i,e.push(a.tag))}return H.set(e)}function ye(e){t.audio!=null&&e&&(t.audio.playbackRate=parseFloat(e))}function ae(e){let i=e.damId;return i.endsWith("-opus16")&&(new Audio().canPlayType("audio/webm")||(i=i.replace(/-opus16$/,""))),i}async function ne(e){var o,l,b,P;const i=(P=(b=(l=(o=D.bookCollections.find(c=>e.collection===c.id))==null?void 0:o.books)==null?void 0:l.find(c=>c.id===e.book))==null?void 0:b.audio)==null?void 0:P.find(c=>e.chapter===""+c.num);if(!i)return;const a=D.audio.sources[i.src];let n=null;if(a.type==="fcbh"){const c=a.address?a.address:"https://4.dbt.io",w=ae(a),C=`${c}/api/bibles/filesets/${w}/${e.book}/${e.chapter}?v=4&key=${a.key}`,d=await(await fetch(C,{method:"GET",headers:{accept:"application/json"}})).json();if(d.error)throw`Failed to connect to BibleBrain: ${d.error}`;n=d.data[0].path}else a.type==="assets"?n=V([`${k}/audio/`,i.filename]):a.type==="download"&&(n=V([a.address,i.filename]));const s=[];if(i.timingFile){const c=`${k}/timings/${i.timingFile}`,w=await fetch(c);if(!w.ok)throw new Error("Failed to read file");const $=(await w.text()).split(`
`);s.push({starttime:0,endtime:0,tag:"title"});for(let d=0;d<$.length;d++){const A=$[d].trim();if(A){if(A.startsWith("\\"))continue;const v=A.split("	");s.push({starttime:parseFloat(v[0]),endtime:parseFloat(v[1]),tag:v[2]})}}}return{source:n,timing:s.length>0?s:null}}function be(e){if(!t.timing)return;const i=t.timing;for(let a=0;a<i.length;a++){const n=t.timing[a].tag,o=/[a-z]/.test(n)?n:n+"a";if(e===o){const l=t.timing[a].starttime;F(l);break}}h()}function oe(e,i){const a=t.timing;let n;for(let s=0;s<a.length;s++){const o=t.timing[s].tag;if(e===o&&(n=t.timing[s].starttime),i===o){const b=t.timing[s].endtime;return{start:n,end:b}}}}function I(e){J(e)}function we(e){T({...e,chapter:""},I),M(e.url)}async function ke(e){N(),await m.set({docSet:e.docSet,book:e.book,chapter:e.chapter,verse:e.verse}),T({collection:e.collection,book:e.book,chapter:e.chapter,verse:e.verse},I),M(`${k}/text`)}async function Te(e){N(),await m.setReference(e);const i=S(m);M(`${k}/text`),T({collection:i.collection,book:i.book,chapter:i.chapter},I)}async function Ie(e){N(),await m.skip(e);const i=S(m);T({collection:i.collection,book:i.book,chapter:i.chapter},I)}export{ke as a,we as b,j as c,pe as d,be as e,me as f,y as g,he as h,fe as i,Ie as j,N as k,Te as n,ge as p,F as s,ye as u};
